---
title: "gdp_prediction_analysis_shortened_data"
author: "Stuart Miller"
date: "April 2, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup

```{r message=FALSE, warning=FALSE}
library(tswge)
library(tswgewrapped)
library(tidyverse)
library(ggplot2)
library(tseries)
data = read.csv("../data/economic_indicators_all_ex_3mo_china.csv")[80:195, ]
```


# Shortened Data


```{r}

data %>% glimpse()
x = data$gdp_change
```

```{r}
px = plotts.sample.wge(x)
```

## Stationarity

We start the analysis with an assessment of startionarity of the realization.

```{r}
tswgewrapped::check_stationarity(x)
```

### Condition 1

* There does not appear to be evidence of a trend in the data.
* Additionaly there does not appear to be any kind of deterministic oscillation in the data

Therefore, the assumption of constant mean does not appear to be violated.

### Condition 2

* There does not apprear to be evidence of the variance of the realization changing over time.
* the drastic change at time step 75 maybe uncharacterisic of the process generating this realization, but it is difficult to determine with only one realization. This could be normal wandering behavior of the process generating this realization.

Therefore, the assumption of constant variance does not appear to be violated.

### Condition 3

The ACF of the first and second half of the realization appear to exhibit similar behavior.
However, the autocorrelations have very low magnitudes - most of the autocorrelations do not appear to be significantly different than 0.

Therefore, the assumption of constant autocorrelation does not appear to be violated.

### Conclusion

Given the above analysis, there does not appear to be sufficient evidence to suggest that the process generating the realization is not stationary.
We will continue the ananlysis assuming the process generating the realization is stationary.

## ARMA Model

Since the process generating the realization is assumed to be stationary, we will model this realization with an ARMA model.

### Model ID

```{r}
aicbic(x, 0:12, 0:3)
```

Both AIC and BIC select low order models with an ARMA(2,0) selected as the best ID by both criteria.
The following models are selected by both criteria:

* ARMA(2,0)
* ARMA(1,1)
* ARMA(2,1)
* ARMA(3,0)


### Model Fit

An ARMA(2,0) was fit based on the model ID from AIC and BIC.
The factor table for the estimated model does not show roots near the unit circle.

```{r}
est.s <- est.arma.wge(x, 2, 0)
```

The results from the model fit appear to be nearly consisent with white noise.
The resulting realization appears very close to white noise.
Several of the autocorrelations of the results are marginally significant, which is more than expected.
As secondary evaluation, the Ljung-Box test does not reject the null hypothesis that residuals are white noise at K = 24, but does reject the null hypothesis at K = 48.
However, all the models selected by AIC and BIC show a similar behavior.

```{r}
tswgewrapped::evaluate_residuals(est.s$res)
```


### Forecast Results


```{r, results='hide'}
models = list("ARMA(2,1)" = list(phi = est.s$phi,
                                  theta = est.s$theta,
                                  vara = est.s$avar,
                                  res = est.s$res,
                                  sliding_ase = TRUE))

mdl_compare = tswgewrapped::ModelCompareUnivariate$new(data = x, mdl_list = models,
                                                       n.ahead = 2, batch_size = 44)
```

The model appears to capture the movement of the mean with 2-step ahead forecasts.
The model is unable to capture the steap dip near time step 75.
Generally, the realization is contained in the forecast limits of the model, but the realization does not exhibit significant wandering.

```{r}
mdl_compare$plot_batch_forecasts(only_sliding = TRUE)
```

The sliding window ASE shows that the model performs badly near the extreme step.

```{r}
mdl_compare$plot_batch_ases(only_sliding = TRUE)
```

```{r}
mdl_compare$plot_histogram_ases()
```


## VAR Modeling

### CCF Analysis


```{r}

lag.max = 12

var_interest = 'gdp_change'

for (name in colnames(data)){
  # By convention, the X2 variable comes first
  c = ccf(data[name], data[var_interest], lag.max = lag.max)
  index = which(abs(c$acf[,1,1]) == max(abs(c$acf[,1,1])))
  max_ccf = c$lag[,1,1][index] 
  cat(paste("\nFor variable: ", name, " , max cross-correlation is at lag: ", max_ccf, sep = ""))
}
```

Subset to variables that may be useful given cross-correlations.

```{r}
data <- data %>% dplyr::select(c(gdp_change, nfjobschg, ipichg, treas10yr,
                                 fedintrate, cpichg, inventorieschg, ppichg, popchg,
                                 homeownership, corpprofitchg, personincomechg, housingpermitschg,
                                 japanchg))
```




### Modeling

Initially we attempted to select models starting with all the variables and removing statistially insiginificant variables.
However, this resulted in models that appeared to be very overfit.
For more details see *VAR Modeling with Backward Feature Selection* in the appendix.

We continued by starting with no variables in the model and visualizing the forecast at each variable addition to determine if the model appeared to overfit.
This resulted in a much smaller model.
The constant term was found to be significant, but the trend term was not significant. 
Thus, we only fit models with the constant term.

The models selected contained the variables `housingpermitschg` and `inventorieschg`.

```{r, message=FALSE}
lag.max = 12
models = list("VARS AIC Both"    = list(select = "aic", trend_type = "const", lag.max = lag.max))
mdl_build = ModelBuildMultivariateVAR$new(data[ , c(var_interest, 'housingpermitschg', 'inventorieschg')],
                                          var_interest = var_interest,
                                            mdl_list = models, verbose = 1)

mdl_build$summarize_build()
mdl_build$build_recommended_models()
model.both <- mdl_build$get_final_models(subset = 'r')

models = list("VARS AIC Inven"    = list(select = "aic", trend_type = "const", lag.max = lag.max))
mdl_build = ModelBuildMultivariateVAR$new(data[ , c(var_interest, 'inventorieschg')],
                                          var_interest = var_interest,
                                            mdl_list = models, verbose = 1)

mdl_build$summarize_build()
mdl_build$build_recommended_models()
model.inven <- mdl_build$get_final_models(subset = 'r')

models = list("VARS AIC HousePerm"    = list(select = "aic", trend_type = "const", lag.max = lag.max))
mdl_build = ModelBuildMultivariateVAR$new(data[ , c(var_interest, 'housingpermitschg')],
                                          var_interest = var_interest,
                                            mdl_list = models, verbose = 1)

mdl_build$summarize_build()
mdl_build$build_recommended_models()
model.housperm <- mdl_build$get_final_models(subset = 'r')

models <- append(model.both, model.inven)
models <- append(models, model.housperm)


for (name in names(models)){
  models[[name]][['sliding_ase']] = TRUE
}

batch_size = 44
n.ahead = 2

mdl_compare = ModelCompareMultivariateVAR$new(data = data, var_interest = var_interest,
                                              mdl_list = models, n.ahead = n.ahead, batch_size = batch_size, verbose = 1)

mdl_compare$plot_batch_forecasts()
mdl_compare$plot_histogram_ases()
```

It is difficult to determine when models appear to perform well based on the plot of the rolling forecasts.
However, there appears to be some evidence that the forecast lags the behavior of the realization.
While there are several instances where this behvaior can be seen, it is particularly evident when the realization dips suddenly near time step 75.
The models forecast a dip in the next time step.

Like the univariate models, these VAR models appear generally tend to capture the movement of the realization within the forecast intervals.

From the plot of the rolling ASE, the model containing only `inventorieschg` appears to perform best.
The ASE appears to be lower on average over the windows with the spread of the main distribution also being lower than the other two models.
The outliers of the ASE plot also appear to be as extreme or less extreme than the other two models.


```{r}
#mdl_compare$evaluate_residuals()
```




# Appendix

## VAR Modeling with Backward Feature Selection

### VAR with `trend_type = Trend`

**Iteration 1**

Starting with all variables with non-zero cross-correlation and max lag of 12.

```{r}
lag.max = 12
models = list("VARS AIC Trend"    = list(select = "aic", trend_type = "trend", lag.max = lag.max))
mdl_build = ModelBuildMultivariateVAR$new(data = data, var_interest = var_interest,
                                            mdl_list = models, verbose = 1)
mdl_build$summarize_build()
```

The recommended model as a lag of 7 and most variables are not significant in the model.
Additionally, trend is not significant in the model.

**Iteration 2**

Variable `japanchg` is removed and max lags remains at 12.


```{r}
lag.max = 12
models = list("VARS AIC Trend"    = list(select = "aic", trend_type = "trend", lag.max = lag.max))
mdl_build = ModelBuildMultivariateVAR$new(data = data[ , c(var_interest, 'nfjobschg', 'ipichg', 'treas10yr',
                                                           'fedintrate', 'cpichg', 'inventorieschg', 'ppichg', 'popchg',
                                                           'homeownership', 'corpprofitchg', 'personincomechg', 'housingpermitschg')],
                                          var_interest = var_interest,
                                            mdl_list = models, verbose = 1)
mdl_build$summarize_build()
```

All varaibles are now significant in the model.
Trend is still not significant at the 0.05 level, but it is marginal.

**Iteration 3**

The max lag to test is reduced to 7.

```{r}
lag.max = 7
models = list("VARS AIC Trend"    = list(select = "aic", trend_type = "trend", lag.max = lag.max))
mdl_build = ModelBuildMultivariateVAR$new(data = data[ , c(var_interest, 'nfjobschg', 'ipichg', 'treas10yr',
                                                           'fedintrate', 'cpichg', 'inventorieschg', 'ppichg', 'popchg',
                                                           'homeownership', 'corpprofitchg', 'personincomechg', 'housingpermitschg')],
                                          var_interest = var_interest,
                                            mdl_list = models, verbose = 1)
mdl_build$summarize_build()
mdl_build$build_recommended_models()
model.trend <- mdl_build$get_final_models(subset = 'r')
```

The recommended model remains the same as the previous model.

### VAR with `trend_type = Both`

**Iteration 1**

Starting with all variables with non-zero cross-correlation and max lag of 12.

```{r}
lag.max = 12
models = list("VARS AIC Both"    = list(select = "aic", trend_type = "both", lag.max = lag.max))
mdl_build = ModelBuildMultivariateVAR$new(data = data,
                                          var_interest = var_interest,
                                            mdl_list = models, verbose = 1)
mdl_build$summarize_build()
```

The recommended model as a lag of 7 and most variables are not significant in the model.
Additionally, trend and const are not significant in the model.

**Iteration 2**

Variable `japanchg` is removed and max lags remains at 12.


```{r}
lag.max = 12
models = list("VARS AIC Both"    = list(select = "aic", trend_type = "both", lag.max = lag.max))
mdl_build = ModelBuildMultivariateVAR$new(data = data[ , c(var_interest, 'nfjobschg', 'ipichg', 'treas10yr',
                                                           'fedintrate', 'cpichg', 'inventorieschg', 'ppichg', 'popchg',
                                                           'homeownership', 'corpprofitchg', 'personincomechg', 'housingpermitschg')],
                                          var_interest = var_interest,
                                            mdl_list = models, verbose = 1)
mdl_build$summarize_build()
```

All varaibles are now significant in the model.
Trend and const are not significant in the model

**Iteration 3**

The max lag to test is reduced to 7.

```{r}
lag.max = 7
models = list("VARS AIC Both"    = list(select = "aic", trend_type = "both", lag.max = lag.max))
mdl_build = ModelBuildMultivariateVAR$new(data = data[ , c(var_interest, 'nfjobschg', 'ipichg', 'treas10yr',
                                                           'fedintrate', 'cpichg', 'inventorieschg', 'ppichg', 'popchg',
                                                           'homeownership', 'corpprofitchg', 'personincomechg', 'housingpermitschg')],
                                          var_interest = var_interest,
                                            mdl_list = models, verbose = 1)
mdl_build$summarize_build()
mdl_build$build_recommended_models()
model.both <- mdl_build$get_final_models(subset = 'r')
```

The recommend model is the same as the previous model.

### VAR with `trend_type = Const`

**Iteration 1**

Starting with all variables with non-zero cross-correlation and max lag of 12.

```{r}
lag.max = 12
models = list("VARS AIC Const"    = list(select = "aic", trend_type = "const", lag.max = lag.max))
mdl_build = ModelBuildMultivariateVAR$new(data = data,
                                          var_interest = var_interest,
                                            mdl_list = models, verbose = 1)
mdl_build$summarize_build()
```

The recommended model as a lag of 7 and most variables are not significant in the model.
Additionally, const is not significant in the model.

**Iteration 2**

Variable `japanchg` is removed and max lags remains at 12.


```{r}
lag.max = 12
models = list("VARS AIC Const"    = list(select = "aic", trend_type = "both", lag.max = lag.max))
mdl_build = ModelBuildMultivariateVAR$new(data = data[ , c(var_interest, 'nfjobschg', 'ipichg', 'treas10yr',
                                                           'fedintrate', 'cpichg', 'inventorieschg', 'ppichg', 'popchg',
                                                           'homeownership', 'corpprofitchg', 'personincomechg', 'housingpermitschg')],
                                          var_interest = var_interest,
                                            mdl_list = models, verbose = 1)
mdl_build$summarize_build()
```

All varaibles are now significant in the model.
Const is not significant in the model

**Iteration 3**

The max lag to test is reduced to 7.

```{r}
lag.max = 7
models = list("VARS AIC Const"    = list(select = "aic", trend_type = "both", lag.max = lag.max))
mdl_build = ModelBuildMultivariateVAR$new(data = data[ , c(var_interest, 'nfjobschg', 'ipichg', 'treas10yr',
                                                           'fedintrate', 'cpichg', 'inventorieschg', 'ppichg', 'popchg',
                                                           'homeownership', 'corpprofitchg', 'personincomechg', 'housingpermitschg')],
                                          var_interest = var_interest,
                                            mdl_list = models, verbose = 1)
mdl_build$summarize_build()
mdl_build$build_recommended_models()
model.const <- mdl_build$get_final_models(subset = 'r')
```

The recommend model is the same as the previous model.

### VAR with `trend_type = None`



```{r}
lag.max = 12
models = list("VARS AIC None"    = list(select = "aic", trend_type = "none", lag.max = lag.max))
mdl_build = ModelBuildMultivariateVAR$new(data = data,
                                          var_interest = var_interest,
                                            mdl_list = models, verbose = 1)
mdl_build$summarize_build()
```


```{r}
lag.max = 12
models = list("VARS AIC None"    = list(select = "aic", trend_type = "none", lag.max = lag.max))
mdl_build = ModelBuildMultivariateVAR$new(data[ , c(var_interest, 'nfjobschg', 'ipichg', 'treas10yr',
                                                           'fedintrate', 'cpichg', 'inventorieschg', 'ppichg', 'popchg',
                                                           'homeownership', 'corpprofitchg', 'personincomechg', 'housingpermitschg')],
                                          var_interest = var_interest,
                                            mdl_list = models, verbose = 1)
mdl_build$summarize_build()
```

```{r}
lag.max = 7
models = list("VARS AIC None"    = list(select = "aic", trend_type = "none", lag.max = lag.max))
mdl_build = ModelBuildMultivariateVAR$new(data[ , c(var_interest, 'nfjobschg', 'ipichg', 'treas10yr',
                                                           'fedintrate', 'cpichg', 'inventorieschg', 'ppichg', 'popchg',
                                                           'homeownership', 'corpprofitchg', 'personincomechg', 'housingpermitschg')],
                                          var_interest = var_interest,
                                            mdl_list = models, verbose = 1)
mdl_build$summarize_build()
mdl_build$build_recommended_models()
model.none <- mdl_build$get_final_models(subset = 'r')
```

The recommended model is the same as the previous model.

### Compare Models

Three models show much higher error than the model with trend type of none.
However, this model still has very large errors compared to the univariate models.

```{r}
models <- append(model.both, model.const)
models <- append(models, model.none)
models <- append(models, model.trend)

for (name in names(models)){
  models[[name]][['sliding_ase']] = TRUE
}

batch_size = 44
n.ahead = 2

mdl_compare = ModelCompareMultivariateVAR$new(data = data, var_interest = var_interest,
                                              mdl_list = models, n.ahead = n.ahead, batch_size = batch_size, verbose = 1)


mdl_compare$plot_batch_forecasts()
mdl_compare$plot_histogram_ases()
```

Rerun the comparison with the noisy models removed.

```{r}
mdl_compare$remove_models(c("VARS AIC Const - R",
                            "VARS AIC Both - R",
                            "VARS AIC Trend - R"))

mdl_compare$plot_batch_forecasts()
mdl_compare$plot_histogram_ases()
```




